<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ผลการเลือกตั้ง (สด) - ระบบเลือกตั้งประธานนักเรียน</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        :root { --primary-blue: #3B82F6; --primary-pink: #EC4899; --leader-color: #F59E0B; --text-color: #1F2937; --background-gradient: linear-gradient(135deg, #EFF6FF 0%, #FCE7F3 100%); }
        body { font-family: 'Kanit', sans-serif; margin: 0; padding: 20px; background: var(--background-gradient); color: var(--text-color); display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .container { background-color: #ffffff; padding: 30px; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); max-width: 1200px; width: 100%; text-align: center; animation: fadeIn 1s ease-out; margin-top: 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h1 { color: var(--primary-blue); font-size: 3.5em; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.05); }
        h2 { color: var(--primary-pink); margin-top: 0; font-size: 2em; font-weight: 600; }
        #chart-container { width: 100%; max-height: 500px; margin: 20px auto; }
        #candidate-cards-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; width: 100%; margin-top: 40px; text-align: left; }
        .candidate-card { background: #f9f9f9; border-radius: 10px; padding: 15px; border: 2px solid transparent; transition: all 0.3s ease; }
        .candidate-card.leader { border-color: var(--leader-color); box-shadow: 0 0 15px rgba(245, 158, 11, 0.5); }
        .candidate-header { display: flex; align-items: center; margin-bottom: 10px; }
        .candidate-photo { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid var(--primary-blue); }
        .candidate-info { flex-grow: 1; }
        .candidate-name { font-size: 1.2em; font-weight: 600; margin: 0; }
        .candidate-votes { font-size: 1.5em; font-weight: 700; color: var(--primary-pink); }
        .progress-bar-container { width: 100%; background-color: #e0e0e0; border-radius: 5px; height: 10px; overflow: hidden; }
        .progress-bar { height: 100%; width: 0%; background-color: var(--primary-blue); border-radius: 5px; transition: width 0.5s ease-out; }
        #total-votes { font-size: 2.5em; font-weight: 700; color: var(--primary-pink); margin-top: 30px; }
        #last-updated { font-size: 1em; color: #777; margin-top: 10px; }
        #status-message { font-size: 1.2em; color: #d9534f; display: none; }
        .footer-link { display: block; margin-top: 30px; font-size: 1.2em; color: var(--primary-blue); text-decoration: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ผลคะแนนเลือกตั้ง (Live)</h1>
        <h2>ประธานนักเรียน</h2>
        <div id="candidate-cards-container"></div>
        <p id="total-votes">จำนวนผู้ลงคะแนนทั้งหมด: <span id="total-votes-span">0</span></p>
        <div id="chart-container"><canvas id="liveVoteChart"></canvas></div>
        <p id="last-updated">อัปเดตล่าสุด: <span>-</span></p>
        <p id="status-message">การเชื่อมต่อล้มเหลว กำลังลองใหม่...</p>
    </div>
    <a href="?">กลับไปหน้าลงคะแนน</a>
    <script>
        const WEB_APP_URL = 'YOUR_WEB_APP_URL_HERE'; // <-- You can paste your Web App URL here
        let liveChartInstance = null; let currentTotalVotes = 0;
        const cardsContainer = document.getElementById('candidate-cards-container');
        const COLOR_PALETTE = [ 'rgba(59, 130, 246, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(249, 115, 22, 0.8)' ];
        const LEADER_COLOR = 'rgba(245, 158, 11, 0.9)';

        async function loadLiveResults() { const result = await callApi('getVoteResults'); if (result.status === 'success') { const candidates = result.results; const totalVotes = candidates.reduce((sum, item) => sum + item.voteCount, 0); const sortedForChart = [...candidates].sort((a, b) => a.voteCount - b.voteCount); const sortedForCards = [...candidates].sort((a, b) => b.voteCount - a.voteCount); displayCandidateCards(sortedForCards, totalVotes); if (!liveChartInstance) { createLiveChart(sortedForChart); } else { updateLiveChart(sortedForChart); } animateTotalVotes(totalVotes); } document.getElementById('last-updated').querySelector('span').textContent = new Date().toLocaleTimeString('th-TH'); }
        function displayCandidateCards(candidates, totalVotes) { cardsContainer.innerHTML = ''; const maxVotes = candidates.length > 0 ? candidates[0].voteCount : 0; candidates.forEach(candidate => { const card = document.createElement('div'); card.className = 'candidate-card'; if (candidate.voteCount === maxVotes && maxVotes > 0) { card.classList.add('leader'); } const percentage = totalVotes > 0 ? ((candidate.voteCount / totalVotes) * 100) : 0; card.innerHTML = `<div class="candidate-header"><img src="${candidate.photoUrl || 'https://via.placeholder.com/80/EFF6FF/6B7280?text=?'}" class="candidate-photo" alt="${candidate.name}"><div class="candidate-info"><p class="candidate-name">เบอร์ ${candidate.number} - ${candidate.name}</p><span class="candidate-votes">${candidate.voteCount.toLocaleString('th-TH')}</span> คะแนน</div></div><div class="progress-bar-container"><div class="progress-bar" style="width: ${percentage}%; background-color: ${card.classList.contains('leader') ? 'var(--leader-color)' : 'var(--primary-blue)'};"></div></div>`; cardsContainer.appendChild(card); }); }
        function updateLiveChart(votes) { const labels = votes.map(v => `เบอร์ ${v.number} - ${v.name}`); const data = votes.map(v => v.voteCount); const total = data.reduce((a, b) => a + b, 0); const maxVotes = Math.max(...data); const backgroundColors = data.map((vote, index) => { return (vote === maxVotes && vote > 0) ? LEADER_COLOR : COLOR_PALETTE[index % COLOR_PALETTE.length]; }); liveChartInstance.data.labels = labels; liveChartInstance.data.datasets[0].data = data; liveChartInstance.data.datasets[0].backgroundColor = backgroundColors; liveChartInstance.options.plugins.datalabels.formatter = (value, context) => { const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0%'; return `${value} (${percentage})`; }; liveChartInstance.update(); }
        async function callApi(action) { try { const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action }), headers: { 'Content-Type': 'application/json' } }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); document.getElementById('status-message').style.display = 'none'; return await response.json(); } catch (error) { console.error('Error calling API:', error); document.getElementById('status-message').style.display = 'block'; return { status: 'error' }; } }
        function createLiveChart(votes) { const ctx = document.getElementById('liveVoteChart').getContext('2d'); Chart.register(ChartDataLabels); const labels = votes.map(v => `เบอร์ ${v.number} - ${v.name}`); const data = votes.map(v => v.voteCount); const total = data.reduce((a, b) => a + b, 0); const maxVotes = Math.max(...data); const backgroundColors = data.map((vote, index) => { return (vote === maxVotes && vote > 0) ? LEADER_COLOR : COLOR_PALETTE[index % COLOR_PALETTE.length]; }); liveChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'คะแนนโหวต', data: data, backgroundColor: backgroundColors, borderColor: '#fff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false }, title: { display: false }, datalabels: { anchor: 'end', align: 'end', formatter: (value, context) => { const percentage = total > 0 ? (value / total * 100).toFixed(1) + '%' : '0%'; return `${value} (${percentage})`; }, font: { size: 16, weight: 'bold' }, color: '#444' } }, scales: { x: { beginAtZero: true, ticks: { font: { size: 14 } } }, y: { ticks: { font: { size: 16 } } } } } }); }
        function animateTotalVotes(newTotal) { const spanElement = document.getElementById('total-votes-span'); const startTotal = currentTotalVotes; if (startTotal === newTotal) return; const duration = 1000; let startTime = null; function animationStep(timestamp) { if (!startTime) startTime = timestamp; const progress = Math.min((timestamp - startTime) / duration, 1); const currentDisplayTotal = Math.floor(progress * (newTotal - startTotal) + startTotal); spanElement.textContent = currentDisplayTotal.toLocaleString('th-TH'); if (progress < 1) { requestAnimationFrame(animationStep); } } requestAnimationFrame(animationStep); currentTotalVotes = newTotal; }
        loadLiveResults(); setInterval(loadLiveResults, 10000);
    </script>
</body>
</html>
